# Database Setup Documentation

## Overview

This document provides comprehensive information about the database setup for the HBM (Huezo Business Management) application.

## Tech Stack

- **Database**: PostgreSQL 14+
- **ORM**: Drizzle ORM
- **Connection**: postgres.js driver
- **Migration**: Drizzle Kit
- **Environment**: dotenv for configuration

## Prerequisites

- PostgreSQL 14+ installed locally (for development)
- Node.js 18+
- npm or yarn

## Environment Variables

The application requires the following environment variables in `.env.local`:

```bash
# Database Configuration
DATABASE_URL="postgresql://username:password@localhost:5432/hbm_dev"
DATABASE_MAX_CONNECTIONS=10

# Application
NODE_ENV="development"
APP_URL="http://localhost:3000"

# NextAuth
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="your-secret-key-here"
```

### Database URL Format

```
postgresql://[user[:password]@][host][:port][/dbname][?param1=value1&...]
```

For production (example with Neon):

```
DATABASE_URL="postgresql://user:password@host.neon.tech/database?sslmode=require"
```

## Available Scripts

### âœ… Optimized Database Management

```bash
# Test database connection
npm run db:test

# Generate new migrations (when needed)
npm run db:generate

# Open Drizzle Studio (database browser)
npm run db:studio

# Push schema changes directly with auto-confirm
npm run db:push

# Seed database with initial data
npm run db:seed

# Drop all tables and recreate schema
npm run db:flush

# Complete automated reset: flush â†’ push â†’ seed
npm run db:reset
```

### âœ… Development Workflow

```bash
# Complete database reset (recommended for development)
npm run db:reset

# Individual steps (if needed)
npm run db:flush    # 1. Drop all tables
npm run db:push     # 2. Create tables from schema
npm run db:seed     # 3. Insert initial data
npm run db:status
```

### Testing & Monitoring

```bash
# Check database health endpoint
curl http://localhost:3000/api/health/db

# Test connection programmatically
npm run db:test
```

## Configuration Files

### `drizzle.config.ts`

```typescript
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  schema: './src/lib/db/schema/index.ts',
  out: './drizzle',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.DATABASE_URL!,
  },
  verbose: true,
  strict: true,
});
```

### Database Connection (`src/lib/db/index.ts`)

- Connection pooling configured with max connections
- Prepared statements disabled for compatibility
- Idle timeout and max lifetime settings
- Optimized for production use

## âœ… Directory Structure

```
src/lib/db/
â”œâ”€â”€ index.ts              # Main database connection
â”œâ”€â”€ connection.ts         # Connection utilities and testing
â”œâ”€â”€ migrate.ts           # Migration runner
â”œâ”€â”€ seed.ts              # Database seeding utilities
â”œâ”€â”€ test-connection.ts   # Connection testing script
â”œâ”€â”€ queries/
â”‚   â””â”€â”€ products.ts      # TypeScript query builders
â””â”€â”€ schema/
    â”œâ”€â”€ index.ts         # Schema barrel exports
    â”œâ”€â”€ auth.ts          # âœ… Users, roles, permissions, sessions
    â”œâ”€â”€ customers.ts     # âœ… Customer management and authentication
    â”œâ”€â”€ products.ts      # âœ… Products, variants, attributes system
    â”œâ”€â”€ orders.ts        # âœ… Order management and workflow
    â”œâ”€â”€ inquiries.ts     # âœ… Inquiry management system
    â”œâ”€â”€ media.ts         # âœ… Media file management
    â””â”€â”€ notifications.ts # âœ… Activity logs and notifications

scripts/
â”œâ”€â”€ db-flush.ts          # âœ… Schema drop and recreate script
â””â”€â”€ db-reset.ts          # âœ… Complete reset workflow script

migrations/              # Generated by drizzle-kit (when using migrations)
â””â”€â”€ 0000_initial_schema.sql

drizzle/
â”œâ”€â”€ meta/
â”‚   â””â”€â”€ _journal.json    # Migration history
â””â”€â”€ [migrations]         # Generated migration files
```

## Connection Pool Configuration

The application uses connection pooling with the following settings:

- **Max Connections**: Configurable via `DATABASE_MAX_CONNECTIONS` (default: 10)
- **Idle Timeout**: 20 seconds
- **Max Lifetime**: 30 minutes
- **Prepared Statements**: Disabled for pool compatibility

## Health Monitoring

### Health Check Endpoint

**GET** `/api/health/db`

Response example:

```json
{
  "status": "healthy",
  "database": {
    "status": "healthy",
    "database": {
      "name": "hbm_dev",
      "user": "username",
      "version": "PostgreSQL",
      "size": "7104 kB",
      "currentTime": "2025-07-11T06:53:56.010665+00:00"
    },
    "connections": {
      "active": "2",
      "maxAllowed": "901",
      "poolMax": 10
    },
    "timestamp": "2025-07-11T06:53:55.951Z"
  },
  "timestamp": "2025-07-11T06:53:55.951Z"
}
```

### Status Codes

- **200**: Database is healthy and accessible
- **503**: Database connection failed
- **500**: Internal server error

## Migration Workflow

1. **Define Schema**: Add/modify schema definitions in `src/lib/db/schema/`
2. **Generate Migration**: Run `npm run db:generate`
3. **Review Migration**: Check generated files in `drizzle/` directory
4. **Run Migration**: Execute `npm run db:migrate`
5. **Verify**: Test with `npm run db:test`

## Development Setup

1. **Install PostgreSQL**:

   ```bash
   # macOS
   brew install postgresql
   brew services start postgresql

   # Ubuntu/Debian
   sudo apt-get install postgresql postgresql-contrib
   sudo systemctl start postgresql
   ```

2. **Create Database**:

   ```sql
   createdb hbm_dev
   ```

3. **Copy Environment**:

   ```bash
   cp .env.example .env.local
   ```

4. **Update Credentials**:
   Edit `.env.local` with your database URL

5. **Test Connection**:
   ```bash
   npm run db:test
   ```

## Production Deployment

1. **Database Provider**: Use managed PostgreSQL (AWS RDS, Neon, Supabase, etc.)
2. **SSL**: Ensure SSL connections are enabled
3. **Connection Pooling**: Configure appropriate pool sizes
4. **Monitoring**: Set up database monitoring and alerts
5. **Backups**: Implement automated backup strategy

## Troubleshooting

### Common Issues

1. **Connection Refused**
   - Ensure PostgreSQL is running
   - Check host and port in DATABASE_URL
   - Verify firewall settings

2. **Authentication Failed**
   - Check username and password
   - Verify user has database access permissions

3. **Database Not Found**
   - Create the database: `createdb database_name`
   - Check database name in URL

4. **SSL Issues**
   - Add `?sslmode=require` to production URLs
   - Use `?sslmode=disable` for local development if needed

### Debug Commands

```bash
# Test raw connection
psql "$DATABASE_URL"

# Check database exists
psql -l

# View connection details
npm run db:status
```

## Performance Considerations

- **Connection Pooling**: Prevents connection exhaustion
- **Query Optimization**: Use indexes for frequently queried columns
- **Connection Limits**: Monitor active connections vs. limits
- **Prepared Statements**: Disabled for pool compatibility, may impact performance

## Security Best Practices

1. **Environment Variables**: Never commit `.env.local` files
2. **Database Users**: Use principle of least privilege
3. **SSL/TLS**: Always use encrypted connections in production
4. **Network**: Restrict database access to application servers only
5. **Monitoring**: Log and monitor database access patterns

## ðŸ“Š Database Schema Reference

### Authentication & User Management

#### `users` - Staff Users

| Column          | Type         | Constraints                            | Purpose                   |
| --------------- | ------------ | -------------------------------------- | ------------------------- |
| id              | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid() | Unique user identifier    |
| email           | varchar(255) | NOT NULL, UNIQUE                       | User login email          |
| password_hash   | varchar(255) | NOT NULL                               | Hashed password           |
| first_name      | varchar(100) | NOT NULL                               | User first name           |
| last_name       | varchar(100) | NOT NULL                               | User last name            |
| phone           | varchar(20)  |                                        | Contact phone number      |
| avatar_media_id | uuid         | FK â†’ media.id, ON DELETE SET NULL      | Profile picture reference |
| is_active       | boolean      | DEFAULT true                           | Account status            |
| role_id         | uuid         | FK â†’ roles.id, ON DELETE SET NULL      | User role assignment      |
| created_at      | timestamp    | DEFAULT now()                          | Record creation time      |
| updated_at      | timestamp    | DEFAULT now()                          | Last update time          |

**Indexes**: email, role_id, avatar_media_id

#### `roles` - User Roles

| Column      | Type        | Constraints                            | Purpose                            |
| ----------- | ----------- | -------------------------------------- | ---------------------------------- |
| id          | uuid        | PRIMARY KEY, DEFAULT gen_random_uuid() | Unique role identifier             |
| name        | varchar(50) | NOT NULL, UNIQUE                       | Role name (e.g., "admin", "staff") |
| description | text        |                                        | Role description                   |
| is_built_in | boolean     | DEFAULT false                          | System role protection flag        |
| created_at  | timestamp   | DEFAULT now()                          | Record creation time               |
| updated_at  | timestamp   | DEFAULT now()                          | Last update time                   |

#### `permissions` - System Permissions

| Column      | Type         | Constraints                            | Purpose                      |
| ----------- | ------------ | -------------------------------------- | ---------------------------- |
| id          | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid() | Unique permission identifier |
| name        | varchar(100) | NOT NULL, UNIQUE                       | Permission name              |
| description | text         |                                        | Permission description       |
| resource    | varchar(50)  | NOT NULL                               | Resource being protected     |
| action      | varchar(50)  | NOT NULL                               | Action being controlled      |
| created_at  | timestamp    | DEFAULT now()                          | Record creation time         |

#### `role_permissions` - Role-Permission Mapping

| Column        | Type | Constraints                                         | Purpose              |
| ------------- | ---- | --------------------------------------------------- | -------------------- |
| role_id       | uuid | PRIMARY KEY, FK â†’ roles.id, ON DELETE CASCADE       | Role reference       |
| permission_id | uuid | PRIMARY KEY, FK â†’ permissions.id, ON DELETE CASCADE | Permission reference |

#### `sessions` - User Sessions (NextAuth.js)

| Column        | Type         | Constraints                                | Purpose                   |
| ------------- | ------------ | ------------------------------------------ | ------------------------- |
| id            | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid()     | Unique session identifier |
| user_id       | uuid         | NOT NULL, FK â†’ users.id, ON DELETE CASCADE | User reference            |
| expires       | timestamp    | NOT NULL                                   | Session expiration time   |
| session_token | varchar(255) | NOT NULL, UNIQUE                           | Session token             |
| access_token  | varchar(255) |                                            | OAuth access token        |
| created_at    | timestamp    | DEFAULT now()                              | Record creation time      |
| updated_at    | timestamp    | DEFAULT now()                              | Last update time          |

### Customer Management

#### `customers` - Customer Profiles

| Column           | Type         | Constraints                            | Purpose                    |
| ---------------- | ------------ | -------------------------------------- | -------------------------- |
| id               | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid() | Unique customer identifier |
| first_name       | varchar(100) | NOT NULL                               | Customer first name        |
| last_name        | varchar(100) | NOT NULL                               | Customer last name         |
| email            | varchar(255) | NOT NULL, UNIQUE                       | Customer email             |
| phone            | varchar(20)  |                                        | Contact phone number       |
| company_name     | varchar(200) |                                        | Business name              |
| brand_name       | varchar(200) |                                        | Brand name                 |
| address          | text         |                                        | Physical address           |
| city             | varchar(100) |                                        | City                       |
| state            | varchar(100) |                                        | State/Province             |
| country          | varchar(100) |                                        | Country                    |
| postal_code      | varchar(20)  |                                        | Postal/ZIP code            |
| profile_media_id | uuid         | FK â†’ media.id, ON DELETE SET NULL      | Profile picture reference  |
| is_active        | boolean      | DEFAULT true                           | Account status             |
| created_by       | uuid         | FK â†’ users.id, ON DELETE SET NULL      | Staff who created record   |
| created_at       | timestamp    | DEFAULT now()                          | Record creation time       |
| updated_at       | timestamp    | DEFAULT now()                          | Last update time           |

**Indexes**: email, profile_media_id

#### `customer_auth` - Customer Authentication

| Column              | Type         | Constraints                                    | Purpose                       |
| ------------------- | ------------ | ---------------------------------------------- | ----------------------------- |
| id                  | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid()         | Unique auth record identifier |
| customer_id         | uuid         | NOT NULL, FK â†’ customers.id, ON DELETE CASCADE | Customer reference            |
| password_hash       | varchar(255) | NOT NULL                                       | Hashed password               |
| last_login          | timestamp    |                                                | Last login time               |
| is_verified         | boolean      | DEFAULT false                                  | Email verification status     |
| verification_token  | varchar(255) |                                                | Email verification token      |
| reset_token         | varchar(255) |                                                | Password reset token          |
| reset_token_expires | timestamp    |                                                | Reset token expiration        |
| created_at          | timestamp    | DEFAULT now()                                  | Record creation time          |
| updated_at          | timestamp    | DEFAULT now()                                  | Last update time              |

### Product Management

#### `order_types` - Order Type Configuration

| Column                     | Type        | Constraints                            | Purpose                                         |
| -------------------------- | ----------- | -------------------------------------- | ----------------------------------------------- |
| id                         | uuid        | PRIMARY KEY, DEFAULT gen_random_uuid() | Unique order type identifier                    |
| name                       | varchar(50) | NOT NULL, UNIQUE                       | Order type name (e.g., "White Label", "Fabric") |
| description                | text        |                                        | Order type description                          |
| is_active                  | boolean     | DEFAULT true                           | Availability status                             |
| supports_products          | boolean     | DEFAULT true                           | Whether order type supports product catalog     |
| supports_variable_products | boolean     | DEFAULT false                          | Whether order type supports product variants    |
| created_at                 | timestamp   | DEFAULT now()                          | Record creation time                            |

**Indexes**: supports_variable_products

#### `products` - Product Catalog

| Column        | Type         | Constraints                                       | Purpose                      |
| ------------- | ------------ | ------------------------------------------------- | ---------------------------- |
| id            | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid()            | Unique product identifier    |
| name          | varchar(200) | NOT NULL                                          | Product name                 |
| description   | text         |                                                   | Product description          |
| sku           | varchar(100) | UNIQUE                                            | Stock keeping unit           |
| order_type_id | uuid         | NOT NULL, FK â†’ order_types.id, ON DELETE RESTRICT | Order type classification    |
| is_variable   | boolean      | DEFAULT false                                     | Whether product has variants |
| is_active     | boolean      | DEFAULT true                                      | Availability status          |
| created_by    | uuid         | FK â†’ users.id, ON DELETE SET NULL                 | Staff who created record     |
| created_at    | timestamp    | DEFAULT now()                                     | Record creation time         |
| updated_at    | timestamp    | DEFAULT now()                                     | Last update time             |

**Constraints**: UNIQUE(name, order_type_id)  
**Indexes**: order_type_id

#### `product_variants` - Product Variations

| Column             | Type         | Constraints                                   | Purpose                             |
| ------------------ | ------------ | --------------------------------------------- | ----------------------------------- |
| id                 | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid()        | Unique variant identifier           |
| product_id         | uuid         | NOT NULL, FK â†’ products.id, ON DELETE CASCADE | Parent product reference            |
| name               | varchar(200) | NOT NULL                                      | Variant name (e.g., "Black, Small") |
| variant_identifier | varchar(100) | NOT NULL, UNIQUE                              | Unique variant SKU                  |
| is_active          | boolean      | DEFAULT true                                  | Availability status                 |
| created_at         | timestamp    | DEFAULT now()                                 | Record creation time                |
| updated_at         | timestamp    | DEFAULT now()                                 | Last update time                    |

**Constraints**: UNIQUE(product_id, name), UNIQUE(variant_identifier)  
**Indexes**: product_id, variant_identifier

#### `product_attribute_definitions` - Attribute Schema

| Column               | Type         | Constraints                            | Purpose                                          |
| -------------------- | ------------ | -------------------------------------- | ------------------------------------------------ |
| id                   | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid() | Unique definition identifier                     |
| name                 | varchar(100) | NOT NULL, UNIQUE                       | Attribute name (e.g., "color", "size")           |
| display_name         | varchar(200) | NOT NULL                               | Human-readable name                              |
| attribute_type       | varchar(50)  | NOT NULL                               | Data type (text, select, number, color, boolean) |
| predefined_values    | jsonb        |                                        | Array of predefined options                      |
| validation_rules     | jsonb        |                                        | Validation constraints                           |
| is_variant_attribute | boolean      | DEFAULT false                          | Whether used for variants                        |
| sort_order           | integer      | DEFAULT 0                              | Display order                                    |
| is_active            | boolean      | DEFAULT true                           | Availability status                              |
| created_by           | uuid         | FK â†’ users.id, ON DELETE SET NULL      | Staff who created record                         |
| created_at           | timestamp    | DEFAULT now()                          | Record creation time                             |
| updated_at           | timestamp    | DEFAULT now()                          | Last update time                                 |

**Indexes**: name, attribute_type, is_variant_attribute

#### `product_attributes` - Product Attribute Values

| Column                  | Type         | Constraints                                                         | Purpose                           |
| ----------------------- | ------------ | ------------------------------------------------------------------- | --------------------------------- |
| id                      | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid()                              | Unique attribute value identifier |
| product_id              | uuid         | NOT NULL, FK â†’ products.id, ON DELETE CASCADE                       | Product reference                 |
| attribute_definition_id | uuid         | NOT NULL, FK â†’ product_attribute_definitions.id, ON DELETE RESTRICT | Attribute definition reference    |
| attribute_value         | varchar(200) |                                                                     | Predefined value selection        |
| custom_value            | text         |                                                                     | Custom value input                |
| created_at              | timestamp    | DEFAULT now()                                                       | Record creation time              |
| updated_at              | timestamp    | DEFAULT now()                                                       | Last update time                  |

**Constraints**:

- UNIQUE(product_id, attribute_definition_id)
- CHECK: Either attribute_value OR custom_value must be provided
- CHECK: Cannot have both attribute_value AND custom_value

**Indexes**: product_id, attribute_definition_id, attribute_value

#### `product_medias` - Product Media Associations

| Column     | Type      | Constraints                                   | Purpose                       |
| ---------- | --------- | --------------------------------------------- | ----------------------------- |
| id         | uuid      | PRIMARY KEY, DEFAULT gen_random_uuid()        | Unique association identifier |
| product_id | uuid      | NOT NULL, FK â†’ products.id, ON DELETE CASCADE | Product reference             |
| media_id   | uuid      | NOT NULL, FK â†’ media.id, ON DELETE CASCADE    | Media file reference          |
| is_primary | boolean   | DEFAULT false                                 | Primary image flag            |
| sort_order | integer   | DEFAULT 0                                     | Display order                 |
| created_at | timestamp | DEFAULT now()                                 | Record creation time          |

**Constraints**: UNIQUE(product_id, media_id)  
**Indexes**: product_id, media_id

### Order Management

#### `orders` - Order Records

| Column                | Type          | Constraints                                     | Purpose                     |
| --------------------- | ------------- | ----------------------------------------------- | --------------------------- |
| id                    | uuid          | PRIMARY KEY, DEFAULT gen_random_uuid()          | Unique order identifier     |
| order_number          | varchar(100)  | NOT NULL, UNIQUE                                | Human-readable order number |
| customer_id           | uuid          | NOT NULL, FK â†’ customers.id, ON DELETE RESTRICT | Customer reference          |
| inquiry_id            | uuid          | FK â†’ inquiries.id, ON DELETE SET NULL           | Source inquiry reference    |
| order_type_id         | uuid          | FK â†’ order_types.id, ON DELETE RESTRICT         | Order type classification   |
| production_stage_id   | uuid          | FK â†’ production_stages.id, ON DELETE SET NULL   | Current production stage    |
| amount                | numeric(10,2) |                                                 | Order total amount          |
| notes                 | text          |                                                 | Order notes                 |
| assigned_to           | uuid          | FK â†’ users.id, ON DELETE SET NULL               | Staff assignment            |
| created_by            | uuid          | FK â†’ users.id, ON DELETE SET NULL               | Staff who created order     |
| quoted_at             | timestamp     |                                                 | Quotation sent time         |
| confirmed_at          | timestamp     |                                                 | Customer confirmation time  |
| production_started_at | timestamp     |                                                 | Production start time       |
| completed_at          | timestamp     |                                                 | Production completion time  |
| shipped_at            | timestamp     |                                                 | Shipping time               |
| delivered_at          | timestamp     |                                                 | Delivery time               |
| canceled_at           | timestamp     |                                                 | Cancellation time           |
| created_at            | timestamp     | DEFAULT now()                                   | Record creation time        |
| updated_at            | timestamp     | DEFAULT now()                                   | Last update time            |

**Constraints**:

- CHECK: confirmed_at >= quoted_at (if both exist)
- CHECK: completed_at >= production_started_at (if both exist)
- CHECK: shipped_at >= completed_at (if both exist)
- CHECK: delivered_at >= shipped_at (if both exist)

**Indexes**: customer_id, order_type_id, production_stage_id, datetime fields

#### `order_items` - Order Line Items

| Column             | Type         | Constraints                                  | Purpose                   |
| ------------------ | ------------ | -------------------------------------------- | ------------------------- |
| id                 | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid()       | Unique item identifier    |
| order_id           | uuid         | NOT NULL, FK â†’ orders.id, ON DELETE CASCADE  | Order reference           |
| product_variant_id | uuid         | FK â†’ product_variants.id, ON DELETE RESTRICT | Product variant reference |
| item_name          | varchar(200) | NOT NULL                                     | Item display name         |
| item_description   | text         |                                              | Item description          |
| quantity           | integer      | NOT NULL, DEFAULT 1, CHECK > 0               | Quantity ordered          |
| specifications     | jsonb        |                                              | Custom specifications     |
| created_at         | timestamp    | DEFAULT now()                                | Record creation time      |

**Indexes**: order_id, specifications (GIN)

#### `order_quotations` - Order Pricing

| Column             | Type          | Constraints                                 | Purpose                     |
| ------------------ | ------------- | ------------------------------------------- | --------------------------- |
| id                 | uuid          | PRIMARY KEY, DEFAULT gen_random_uuid()      | Unique quotation identifier |
| order_id           | uuid          | NOT NULL, FK â†’ orders.id, ON DELETE CASCADE | Order reference             |
| quotation_number   | varchar(100)  | NOT NULL, UNIQUE                            | Quotation number            |
| amount             | numeric(10,2) | NOT NULL, CHECK > 0                         | Quoted amount               |
| quotation_media_id | uuid          | FK â†’ media.id, ON DELETE SET NULL           | PDF quotation document      |
| notes              | text          |                                             | Quotation notes             |
| is_accepted        | boolean       | DEFAULT false                               | Customer acceptance status  |
| valid_until        | timestamp     |                                             | Quotation expiration        |
| created_by         | uuid          | FK â†’ users.id, ON DELETE SET NULL           | Staff who created quotation |
| created_at         | timestamp     | DEFAULT now()                               | Record creation time        |
| updated_at         | timestamp     | DEFAULT now()                               | Last update time            |

**Indexes**: quotation_media_id

#### `order_attachments` - Order File Attachments

| Column     | Type      | Constraints                                 | Purpose                      |
| ---------- | --------- | ------------------------------------------- | ---------------------------- |
| id         | uuid      | PRIMARY KEY, DEFAULT gen_random_uuid()      | Unique attachment identifier |
| order_id   | uuid      | NOT NULL, FK â†’ orders.id, ON DELETE CASCADE | Order reference              |
| media_id   | uuid      | NOT NULL, FK â†’ media.id, ON DELETE CASCADE  | Media file reference         |
| sort_order | integer   | DEFAULT 0                                   | Display order                |
| created_at | timestamp | DEFAULT now()                               | Record creation time         |

**Constraints**: UNIQUE(order_id, media_id)  
**Indexes**: order_id, media_id

#### `order_specification_definitions` - Dynamic Order Fields

| Column           | Type         | Constraints                                       | Purpose                                |
| ---------------- | ------------ | ------------------------------------------------- | -------------------------------------- |
| id               | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid()            | Unique field definition identifier     |
| order_type_id    | uuid         | NOT NULL, FK â†’ order_types.id, ON DELETE RESTRICT | Order type reference                   |
| field_name       | varchar(100) | NOT NULL                                          | Technical field name                   |
| field_type       | varchar(50)  | NOT NULL                                          | Data type (text, number, select, etc.) |
| field_label      | varchar(200) | NOT NULL                                          | Display label                          |
| is_required      | boolean      | DEFAULT false                                     | Required field flag                    |
| validation_rules | jsonb        |                                                   | Field validation rules                 |
| field_options    | jsonb        |                                                   | Options for select fields              |
| sort_order       | integer      | DEFAULT 0                                         | Display order                          |
| is_active        | boolean      | DEFAULT true                                      | Field availability                     |
| created_by       | uuid         | FK â†’ users.id, ON DELETE SET NULL                 | Staff who created field                |
| created_at       | timestamp    | DEFAULT now()                                     | Record creation time                   |
| updated_at       | timestamp    | DEFAULT now()                                     | Last update time                       |

**Constraints**: UNIQUE(order_type_id, field_name)  
**Indexes**: order_type_id

#### `order_specification_values` - Dynamic Order Field Values

| Column                      | Type      | Constraints                                                           | Purpose                    |
| --------------------------- | --------- | --------------------------------------------------------------------- | -------------------------- |
| id                          | uuid      | PRIMARY KEY, DEFAULT gen_random_uuid()                                | Unique value identifier    |
| order_id                    | uuid      | NOT NULL, FK â†’ orders.id, ON DELETE CASCADE                           | Order reference            |
| specification_definition_id | uuid      | NOT NULL, FK â†’ order_specification_definitions.id, ON DELETE RESTRICT | Field definition reference |
| field_value                 | text      |                                                                       | Field value                |
| created_at                  | timestamp | DEFAULT now()                                                         | Record creation time       |
| updated_at                  | timestamp | DEFAULT now()                                                         | Last update time           |

**Indexes**: order_id

#### `order_status_history` - Order Status Changes

| Column          | Type        | Constraints                                 | Purpose                          |
| --------------- | ----------- | ------------------------------------------- | -------------------------------- |
| id              | uuid        | PRIMARY KEY, DEFAULT gen_random_uuid()      | Unique history record identifier |
| order_id        | uuid        | NOT NULL, FK â†’ orders.id, ON DELETE CASCADE | Order reference                  |
| previous_status | varchar(50) |                                             | Previous order status            |
| new_status      | varchar(50) | NOT NULL                                    | New order status                 |
| changed_by      | uuid        | FK â†’ users.id, ON DELETE SET NULL           | Staff who made change            |
| notes           | text        |                                             | Change notes                     |
| created_at      | timestamp   | DEFAULT now()                               | Record creation time             |

#### `production_stages` - Production Stage Definitions

| Column        | Type         | Constraints                                       | Purpose                 |
| ------------- | ------------ | ------------------------------------------------- | ----------------------- |
| id            | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid()            | Unique stage identifier |
| name          | varchar(100) | NOT NULL                                          | Stage name              |
| description   | text         |                                                   | Stage description       |
| order_type_id | uuid         | NOT NULL, FK â†’ order_types.id, ON DELETE RESTRICT | Order type reference    |
| sort_order    | integer      | DEFAULT 0                                         | Stage sequence order    |
| is_active     | boolean      | DEFAULT true                                      | Stage availability      |
| created_by    | uuid         | FK â†’ users.id, ON DELETE SET NULL                 | Staff who created stage |
| created_at    | timestamp    | DEFAULT now()                                     | Record creation time    |
| updated_at    | timestamp    | DEFAULT now()                                     | Last update time        |

**Indexes**: order_type_id

### Inquiry Management

#### `inquiries` - Customer Inquiries

| Column         | Type         | Constraints                             | Purpose                                                                 |
| -------------- | ------------ | --------------------------------------- | ----------------------------------------------------------------------- |
| id             | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid()  | Unique inquiry identifier                                               |
| customer_name  | varchar(200) | NOT NULL                                | Inquirer name                                                           |
| customer_email | varchar(255) | NOT NULL                                | Inquirer email                                                          |
| customer_phone | varchar(20)  |                                         | Inquirer phone                                                          |
| company_name   | varchar(200) |                                         | Company name                                                            |
| brand_name     | varchar(200) |                                         | Brand name                                                              |
| service_type   | uuid         | FK â†’ order_types.id, ON DELETE SET NULL | Service type requested                                                  |
| message        | text         | NOT NULL                                | Inquiry message                                                         |
| status         | integer      | DEFAULT 1, CHECK BETWEEN 0 AND 4        | Inquiry status (0=New, 1=Assigned, 2=Accepted, 3=In Progress, 4=Closed) |
| assigned_to    | uuid         | FK â†’ users.id, ON DELETE SET NULL       | Staff assignment                                                        |
| customer_id    | uuid         | FK â†’ customers.id, ON DELETE SET NULL   | Linked customer                                                         |
| created_by     | uuid         | FK â†’ users.id, ON DELETE SET NULL       | Staff who created inquiry                                               |
| accepted_at    | timestamp    |                                         | Acceptance time                                                         |
| rejected_at    | timestamp    |                                         | Rejection time                                                          |
| closed_at      | timestamp    |                                         | Closure time                                                            |
| created_at     | timestamp    | DEFAULT now()                           | Record creation time                                                    |
| updated_at     | timestamp    | DEFAULT now()                           | Last update time                                                        |

**Indexes**: (status, assigned_to), customer_id, datetime fields

#### `inquiry_attachments` - Inquiry File Attachments

| Column     | Type      | Constraints                                    | Purpose                      |
| ---------- | --------- | ---------------------------------------------- | ---------------------------- |
| id         | uuid      | PRIMARY KEY, DEFAULT gen_random_uuid()         | Unique attachment identifier |
| inquiry_id | uuid      | NOT NULL, FK â†’ inquiries.id, ON DELETE CASCADE | Inquiry reference            |
| media_id   | uuid      | NOT NULL, FK â†’ media.id, ON DELETE CASCADE     | Media file reference         |
| sort_order | integer   | DEFAULT 0                                      | Display order                |
| created_at | timestamp | DEFAULT now()                                  | Record creation time         |

**Constraints**: UNIQUE(inquiry_id, media_id)  
**Indexes**: inquiry_id, media_id

#### `inquiry_status_history` - Inquiry Status Changes

| Column          | Type      | Constraints                                    | Purpose                          |
| --------------- | --------- | ---------------------------------------------- | -------------------------------- |
| id              | uuid      | PRIMARY KEY, DEFAULT gen_random_uuid()         | Unique history record identifier |
| inquiry_id      | uuid      | NOT NULL, FK â†’ inquiries.id, ON DELETE CASCADE | Inquiry reference                |
| previous_status | integer   |                                                | Previous inquiry status          |
| new_status      | integer   | NOT NULL                                       | New inquiry status               |
| changed_by      | uuid      | FK â†’ users.id, ON DELETE SET NULL              | Staff who made change            |
| notes           | text      |                                                | Change notes                     |
| created_at      | timestamp | DEFAULT now()                                  | Record creation time             |

### Media Management

#### `media` - File Storage Registry

| Column               | Type         | Constraints                            | Purpose                                  |
| -------------------- | ------------ | -------------------------------------- | ---------------------------------------- |
| id                   | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid() | Unique media identifier                  |
| original_name        | varchar(255) | NOT NULL                               | Original filename                        |
| file_name            | varchar(255) | NOT NULL                               | Stored filename                          |
| file_path            | varchar(500) | NOT NULL                               | Storage path                             |
| file_size            | bigint       | NOT NULL, CHECK > 0                    | File size in bytes                       |
| mime_type            | varchar(100) | NOT NULL                               | MIME type                                |
| file_type            | varchar(50)  | NOT NULL                               | File category (image, video, audio, pdf) |
| alt_text             | varchar(255) |                                        | Alternative text for accessibility       |
| uploaded_by          | uuid         | FK â†’ users.id, ON DELETE SET NULL      | Staff uploader                           |
| uploaded_by_customer | uuid         | FK â†’ customers.id, ON DELETE SET NULL  | Customer uploader                        |
| created_at           | timestamp    | DEFAULT now()                          | Upload time                              |

**Indexes**: uploaded_by, uploaded_by_customer

### Activity & Notifications

#### `activity_logs` - System Activity Tracking

| Column      | Type         | Constraints                            | Purpose               |
| ----------- | ------------ | -------------------------------------- | --------------------- |
| id          | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid() | Unique log identifier |
| user_id     | uuid         | FK â†’ users.id, ON DELETE SET NULL      | Staff user reference  |
| customer_id | uuid         | FK â†’ customers.id, ON DELETE SET NULL  | Customer reference    |
| action      | varchar(100) | NOT NULL                               | Action performed      |
| entity_type | varchar(50)  | NOT NULL                               | Entity type affected  |
| entity_id   | uuid         | NOT NULL                               | Entity identifier     |
| details     | jsonb        |                                        | Additional details    |
| ip_address  | inet         |                                        | Client IP address     |
| user_agent  | text         |                                        | Client user agent     |
| created_at  | timestamp    | DEFAULT now()                          | Action time           |

#### `notifications` - User Notifications

| Column                | Type         | Constraints                            | Purpose                        |
| --------------------- | ------------ | -------------------------------------- | ------------------------------ |
| id                    | uuid         | PRIMARY KEY, DEFAULT gen_random_uuid() | Unique notification identifier |
| recipient_id          | uuid         | FK â†’ users.id, ON DELETE CASCADE       | Staff recipient                |
| recipient_customer_id | uuid         | FK â†’ customers.id, ON DELETE CASCADE   | Customer recipient             |
| title                 | varchar(200) | NOT NULL                               | Notification title             |
| message               | text         | NOT NULL                               | Notification message           |
| type                  | varchar(50)  | NOT NULL                               | Notification type              |
| entity_type           | varchar(50)  |                                        | Related entity type            |
| entity_id             | uuid         |                                        | Related entity identifier      |
| is_read               | boolean      | DEFAULT false                          | Read status                    |
| created_at            | timestamp    | DEFAULT now()                          | Notification time              |

## âœ… Database Schema Status

**Issue #4: Database Schema Setup - COMPLETED**

The database schema setup has been successfully implemented and is production-ready:

### âœ… Completed Features

1. **âœ… Schema Definition**: All database schemas have been defined and implemented
   - Authentication & user management (`auth.ts`)
   - Customer management (`customers.ts`)
   - Product catalog with variants (`products.ts`)
   - Order management workflow (`orders.ts`)
   - Inquiry management (`inquiries.ts`)
   - Media file management (`media.ts`)
   - Notifications & activity logs (`notifications.ts`)

2. **âœ… Database Management Scripts**: Fully automated workflow
   - `npm run db:flush` - Drop and recreate schema
   - `npm run db:push --force` - Push schema automatically
   - `npm run db:seed` - Seed initial data
   - `npm run db:reset` - Complete automated reset (flush â†’ push â†’ seed)

3. **âœ… PostgreSQL Compatibility**: All compatibility issues resolved
   - Modern Drizzle ORM syntax implemented
   - Check constraints optimized for PostgreSQL
   - Application-level validation for complex business rules

4. **âœ… Production Ready**: Schema is fully validated and tested
   - All relationships and constraints implemented
   - Performance indexes in place
   - Business logic constraints enforced

### ðŸ“‹ Schema Overview

The implemented schema includes **27 tables** with:

- **Authentication system**: Users, roles, permissions, sessions
- **Customer management**: Customer profiles and authentication
- **Product catalog**: Products, variants, attributes with dynamic configuration
- **Order workflow**: Complete order lifecycle from inquiry to delivery
- **Media management**: Centralized file storage and associations
- **Activity tracking**: Comprehensive logging and notifications

## Next Steps

The database foundation is complete. Next development phases:

1. **API Layer**: Build REST endpoints for database operations
2. **Business Logic**: Implement application-specific validation and workflows
3. **Authentication**: Integrate NextAuth.js with the user schema
4. **Frontend**: Build UI components for data management
